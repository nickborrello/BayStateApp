name: Scrape Runner

on:
  workflow_dispatch:
    inputs:
      job_id:
        description: 'Supabase job ID for tracking'
        required: true
        type: string
      skus:
        description: 'Comma-separated list of SKUs to scrape'
        required: false
        type: string
      scrapers:
        description: 'Comma-separated list of scraper names to run'
        required: false
        type: string
      test_mode:
        description: 'Run in test mode'
        required: false
        type: boolean
        default: false
      max_workers:
        description: 'Maximum number of concurrent workers'
        required: false
        type: number
        default: 3

# Only run on self-hosted runners with Docker
jobs:
  scrape:
    runs-on: [self-hosted, docker]
    timeout-minutes: 60

    steps:
      - name: Update job status to running
        env:
          JOB_ID: ${{ inputs.job_id }}
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          curl -X PATCH \
            "${SUPABASE_URL}/rest/v1/scrape_jobs?id=eq.${JOB_ID}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -d '{"status": "running"}'

      - name: Run scraping job in Docker
        id: scrape
        env:
          JOB_ID: ${{ inputs.job_id }}
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          RUNNER_NAME: ${{ runner.name }}
        run: |
          # Build Docker command args
          DOCKER_ARGS=""
          
          if [ -n "${{ inputs.skus }}" ]; then
            SKUS=$(echo "${{ inputs.skus }}" | tr ',' ' ')
            DOCKER_ARGS="$DOCKER_ARGS --skus $SKUS"
          fi
          
          if [ -n "${{ inputs.scrapers }}" ]; then
            SCRAPERS=$(echo "${{ inputs.scrapers }}" | tr ',' ' ')
            DOCKER_ARGS="$DOCKER_ARGS --scrapers $SCRAPERS"
          fi
          
          if [ "${{ inputs.test_mode }}" = "true" ]; then
            DOCKER_ARGS="$DOCKER_ARGS --test-mode"
          fi
          
          DOCKER_ARGS="$DOCKER_ARGS --max-workers ${{ inputs.max_workers }}"
          
          echo "Running Docker: baystate-scraper:latest $DOCKER_ARGS"
          
          docker run --rm \
            -e SUPABASE_URL="${SUPABASE_URL}" \
            -e SUPABASE_SERVICE_ROLE_KEY="${SUPABASE_SERVICE_ROLE_KEY}" \
            -e JOB_ID="${JOB_ID}" \
            -e RUNNER_NAME="${RUNNER_NAME}" \
            baystate-scraper:latest $DOCKER_ARGS

      - name: Update job status to completed
        if: success()
        env:
          JOB_ID: ${{ inputs.job_id }}
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          RUNNER_NAME: ${{ runner.name }}
        run: |
          curl -X PATCH \
            "${SUPABASE_URL}/rest/v1/scrape_jobs?id=eq.${JOB_ID}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"status\": \"completed\", \"completed_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}"
          
          # Insert result record
          curl -X POST \
            "${SUPABASE_URL}/rest/v1/scrape_results" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"job_id\": \"${JOB_ID}\", \"runner_name\": \"${RUNNER_NAME}\", \"data\": {\"status\": \"success\", \"skus\": \"${{ inputs.skus }}\", \"scrapers\": \"${{ inputs.scrapers }}\"}}"

      - name: Update job status on failure
        if: failure()
        env:
          JOB_ID: ${{ inputs.job_id }}
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          curl -X PATCH \
            "${SUPABASE_URL}/rest/v1/scrape_jobs?id=eq.${JOB_ID}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"status\": \"failed\", \"completed_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"error_message\": \"Workflow failed - check GitHub Actions logs\"}"
